name: TruthPulse Engine
on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 6 * * *'  # Daily at 06:00 UTC

jobs:
  evidence-compiler:
    runs-on: ubuntu-latest
    container: python:3.9-slim
    steps:
      - name: Install OS packages
        run: |
          apt-get update && \
          apt-get install -y --no-install-recommends curl git coreutils && \
          rm -rf /var/lib/apt/lists/*
      - uses: actions/checkout@v4
      - name: Verify suppression evidence file exists
        run: ls -la data/suppression_evidence.csv || echo "File not found"
      - name: Create output directory
        run: mkdir -p out
      - name: Install Python dependencies
        run: |
          for i in {1..3}; do pip install pandas numpy && break || sleep 1; done
      - name: Compile Evidence
        working-directory: /github/workspace
        run: |
          python - << 'PY'
import pandas as pd
df = pd.read_csv('data/suppression_evidence.csv')
df[['SNP','Sample','Status']].to_json('out/evidence_summary.json')
with open('out/x_thread.txt','w') as f:
    f.write(f"E-M329 suppression exposed! {len(df)} SNPs hidden. github.com/IsraeliteGenomeJustice/shemite-genome-reclamation #ShemiteTruth")
PY
      - name: Anchor to Ethereum Layer-2
        working-directory: /github/workspace
        run: |
          curl -s -X POST -H 'Content-Type:application/json' \
          --data "{\"hashes\":[\"$(sha256sum out/evidence_summary.json | cut -d' ' -f1)\"]}" \
          https://api.chainpoint.org/v3/anchors/optimism > out/chainpoint_proof.json
      - name: Pin artefacts to IPFS
        working-directory: /github/workspace
        uses: aquiladev/ipfs-action@v0.3.1
        with:
          path: out/evidence_summary.json,out/x_thread.txt,out/chainpoint_proof.json
          service: pinata
          pinataKey: ${{ secrets.PINATA_JWT }}
          pinataSecret: ${{ secrets.PINATA_JWT }}
      - name: Commit Proofs
        working-directory: /github/workspace
        run: |
          git config user.name "TruthPulse-Bot"
          git config user.email "bot@users.noreply.github.com"
          git add out/*
          git commit -m "TruthPulse proof $(date -u +%F)" || echo "No changes"
          git push
